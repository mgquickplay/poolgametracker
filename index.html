// File: Code.gs
// Stores/retrieves encrypted text in Google Drive, keyed by ?key=... (your phrase hash).
// Deploy: Deploy > New deployment > Web app > Execute as Me; Who has access: Anyone with the link.

function doGet(e) {
  const key = (e.parameter.key || "").trim();
  const op = (e.parameter.op || "get").trim();
  if (!key) return _resp(400, "Missing key");
  if (op !== "get") return _resp(400, "Invalid op");

  const file = _findFile(key);
  if (!file) return _resp(404, "Not found");
  const content = file.getBlob().getDataAsString("UTF-8");
  return _json(content);
}

function doPost(e) {
  const key = (e.parameter.key || "").trim();
  const op = (e.parameter.op || "put").trim();
  if (!key) return _resp(400, "Missing key");
  if (op !== "put") return _resp(400, "Invalid op");

  const body = e.postData && e.postData.contents || "";
  if (!body) return _resp(400, "Missing body");

  let file = _findFile(key);
  if (file) file.setContent(body);
  else file = DriveApp.createFile(key + ".json", body, MimeType.PLAIN_TEXT);

  return _resp(200, "OK");
}

function _findFile(key) {
  const it = DriveApp.getFilesByName(key + ".json");
  return it.hasNext() ? it.next() : null;
}
function _json(text) {
  const out = ContentService.createTextOutput(text);
  out.setMimeType(ContentService.MimeType.JSON);
  _cors(out);
  return out;
}
function _resp(code, msg) {
  const out = ContentService.createTextOutput(msg);
  out.setMimeType(ContentService.MimeType.TEXT);
  _cors(out);
  return out;
}
function _cors(out) {
  const resp = out;
  // Apps Script doesn't let us set arbitrary headers in ContentService responses,
  // but CORS is generally okay for simple GET/POST. If needed, enable CORS via HTMLService proxy.
}
